const fs = require("fs");
const path = require("path");
const { cmd } = require("../command");

const OWNER_PATH = path.join(__dirname, "../lib/owner.json");

// ŸÖÿ∑ŸÖÿ¶ŸÜ ÿ¥Ÿà ŸÅÿß€åŸÑ owner.json Ÿáÿ≥ÿ™
const ensureOwnerFile = () => {
  if (!fs.existsSync(OWNER_PATH)) {
    fs.writeFileSync(OWNER_PATH, JSON.stringify([]));
  }
};

// ÿßŸÅÿ≤ŸàÿØŸÜ ÿ¥ŸÖÿßÿ±Ÿá ÿ®Ÿá owner.json
cmd({
    pattern: "addsudo",
    alias: [],
    desc: "Add a temporary owner",
    category: "owner",
    react: "‚úÖ",
    filename: __filename
}, async (conn, mek, m, { from, args, q, isCreator, reply, isOwner }) => {
    try {
        if (!isCreator) return reply("_*‚ùóThis Command Can Only Be Used By My Owner !*_");

        // Ÿæ€åÿØÿß ⁄©ÿ±ÿØŸÜ ŸáÿØŸÅ (ÿ¥ŸÖÿßÿ±Ÿá €åÿß ⁄©ÿßÿ±ÿ®ÿ±)
        let target = m.mentionedJid?.[0] 
            || (m.quoted?.sender ?? null)
            || (args[0]?.replace(/[^0-9]/g, '') + "@s.whatsapp.net");

        // ÿß⁄Øÿ± Ÿá€å⁄Ü ŸáÿØŸÅ€å Ÿàÿßÿ±ÿØ ŸÜÿ¥ÿØŸá ÿ®ŸàÿØÿå Ÿæ€åÿßŸÖ ÿÆÿ∑ÿß ÿ®ÿØŸá
        if (!q) return reply("‚ùå Please provide a number or tag/reply a user.");

        let own = JSON.parse(fs.readFileSync("./lib/owner.json", "utf-8"));

        if (own.includes(target)) {
            return reply("‚ùå This user is already a temporary owner.");
        }

        own.push(target);
        const uniqueOwners = [...new Set(own)];
        fs.writeFileSync("./lib/owner.json", JSON.stringify(uniqueOwners, null, 2));

        const dec = "‚úÖ Successfully Added User As Temporary Owner";
        await conn.sendMessage(from, {  // ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ await ÿØÿ± ÿß€åŸÜÿ¨ÿß ÿØÿ±ÿ≥ÿ™ ÿßÿ≥ÿ™
            image: { url: "https://files.catbox.moe/6vrc2s.jpg" },
            caption: dec
        }, { quoted: mek });
    } catch (err) {
        console.error(err);
        reply("‚ùå Error: " + err.message);
    }
});

// ÿ≠ÿ∞ŸÅ ÿ¥ŸÖÿßÿ±Ÿá ÿßÿ≤ owner.json
cmd({
    pattern: "delsudo",
    alias: [],
    desc: "Remove a temporary owner",
    category: "owner",
    react: "‚ùå",
    filename: __filename
}, async (conn, mek, m, { from, args, q, isCreator, reply, isOwner }) => {
    try {
        if (!isCreator) return reply("_*‚ùóThis Command Can Only Be Used By My Owner !*_");

        let target = m.mentionedJid?.[0] 
            || (m.quoted?.sender ?? null)
            || (args[0]?.replace(/[^0-9]/g, '') + "@s.whatsapp.net");

        // ÿß⁄Øÿ± Ÿá€å⁄Ü ŸáÿØŸÅ€å Ÿàÿßÿ±ÿØ ŸÜÿ¥ÿØŸá ÿ®ŸàÿØÿå Ÿæ€åÿßŸÖ ÿÆÿ∑ÿß ÿ®ÿØŸá
        if (!q) return reply("‚ùå Please provide a number or tag/reply a user.");

        let own = JSON.parse(fs.readFileSync("./lib/owner.json", "utf-8"));

        if (!own.includes(target)) {
            return reply("‚ùå User not found in owner list.");
        }

        const updated = own.filter(x => x !== target);
        fs.writeFileSync("./lib/owner.json", JSON.stringify(updated, null, 2));

        const dec = "‚úÖ Successfully Removed User As Temporary Owner";
        await conn.sendMessage(from, {  // ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ await ÿØÿ± ÿß€åŸÜÿ¨ÿß ÿØÿ±ÿ≥ÿ™ ÿßÿ≥ÿ™
            image: { url: "https://files.catbox.moe/6vrc2s.jpg" },
            caption: dec
        }, { quoted: mek });
    } catch (err) {
        console.error(err);
        reply("‚ùå Error: " + err.message);
    }
});

cmd({
    pattern: "listsudo",
    alias: [],
    desc: "List all temporary owners",
    category: "owner",
    react: "üìã",
    filename: __filename
}, async (conn, mek, m, { from, args, isCreator, reply, isOwner }) => {
    try {
    if (!isCreator) return reply("_*‚ùóThis Command Can Only Be Used By My Owner !*_");
        // Check if the user is the owner
        if (!isOwner) {
            return reply("‚ùå You are not the bot owner.");
        }

        // Read the owner list from the file and remove duplicates
        let own = JSON.parse(fs.readFileSync("./lib/owner.json", "utf-8"));
        own = [...new Set(own)]; // Remove duplicates

        // If no temporary owners exist
        if (own.length === 0) {
            return reply("‚ùå No temporary owners found.");
        }

        // Create the message with owner list
        let listMessage = "*üåü List of Temporary Owners:*\n\n";
        own.forEach((owner, index) => {
            listMessage += `${index + 1}. ${owner.replace("@s.whatsapp.net", "")}\n`;
        });

        // Send the message with an image and formatted caption
        await conn.sendMessage(from, {
            image: { url: "https://files.catbox.moe/6vrc2s.jpg" },
            caption: listMessage
        }, { quoted: mek });
    } catch (err) {
        // Handle errors
        console.error(err);
        reply("‚ùå Error: " + err.message);
    }
});